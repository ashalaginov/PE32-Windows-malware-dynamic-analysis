#!/bin/sh

# Output directory - create if not present
for d in files/*/ ; do
    for f in $d* ; do
		for file in $f/* ; do
			echo $(basename $file)
			# make dir in results folder
			mkdir "results/"$(basename $d)"/"$(basename $f)
			mkdir "results/"$(basename $d)"/"$(basename $f)"/"$(basename $file)
			localDir="results/"$(basename $d)"/"$(basename $f)"/"$(basename $file)"/"

			# Revert VM to Initial State
			VBoxManage snapshot "Win7" restore "Starter7"
			VBoxManage startvm "Win7" --type headless
			sleep 30s

			readyTest=$(VBoxManage guestcontrol "Win7" --verbose  --username Administrator run --exe "C:\Windows\System32\cmd.exe" -- cmd.exe /c tasklist | grep Services | grep "Services");
			while [ "$readyTest" = "" ]
			do
				sleep 10s
				readyTest=$(VBoxManage guestcontrol "Win7" --verbose  --username Administrator run --exe "C:\Windows\System32\cmd.exe" -- cmd.exe /c tasklist | grep Services | grep "Services");   
				echo "still waiting"
			done

			# Transfer malware file
			cp $file ~/Public/
			mv ~/Public/$(basename $file) ~/Public/$(basename $file).exe


			# Pre-execution
			touch ~/Public/CaptureBat.log
			screen -d -m VBoxManage guestcontrol "Win7" --verbose  --username Administrator run --exe "C:\Windows\System32\cmd.exe" -- cmd.exe /c "C:\Program Files\Capture\CaptureBat.exe" -- "-c" "-n"  "-l" "E:\CaptureBat.log"
			sleep 5s

			# Execution
			screen -d -m VBoxManage guestcontrol "Win7" --verbose  --username Administrator run --exe "C:\Windows\System32\cmd.exe" -- cmd.exe /c 'E:\'$(basename $file)'.exe'
			sleep 30s

			# Post-execution
			kill -INT $(ps aux | grep cmd.exe | grep virtualbox | awk '{print $2}')
			sleep 2s
			killall screen -9
			sleep 2s
			CBlog=$(VBoxManage guestcontrol "Win7" --verbose  --username Administrator run --exe "C:\Windows\System32\cmd.exe" -- cmd.exe /c dir "C:\Program Files\Capture" | grep "capture_" |awk '{ print $NF }' | tail -n 1  |tr -d '\r');
			echo $CBlog
			echo $PWD
			VBoxManage guestcontrol "Win7" copyfrom 'C:\Program Files\Capture\'$CBlog --target-directory $PWD/$localDir$CBlog   --username "Administrator" --verbose
			mv ~/Public/CaptureBat.log  $localDir

			mv ~/Public/$(basename $file).exe  $localDir

			# Power off
			VBoxManage controlvm "Win7" poweroff
			sleep 5s
			killall VBoxManage VBoxHeadless
		done
    done
done

