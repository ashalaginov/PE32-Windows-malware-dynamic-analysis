<?php

/// MySQL DB name
$db_name = "peanalysis";
///MySQL DB user
$db_user = "peanalysis";
///MySQL DB password
$db_password = "peanalys";
///MySQL server address
$db_host = "localhost";

//Make MySQL Conntection
if (mysql_connect($db_host, $db_user, $db_password) === FALSE)
    $this->output.="Cannot Create Connection to DB<br>";
if (mysql_select_db($db_name) === FALSE)
    $this->output.="Cannot Select the Table into DB<br>";


$type="family";
chdir("files/".$type);
$dirs = array_filter(glob('*'), 'is_dir');
print_r( $dirs);

//Path to the storage with files (names as md5)
$dir = '/home/malwarelab/malware_collection/windows/PE/';
$name="";

//Extract relevant files based on the absense of Anti-Debug and Anti-VM fewatures per malware family - subject to your own malware collection
foreach ($dirs as $name){
    echo $name."\n";
    $i=0;
    $query = "SELECT data.md5, data.pe_dll, data.type, data.family, rawData.file, rawData.size_of_file, rawData.peframe
    FROM data
    INNER JOIN rawData ON data.md5 = rawData.md5
    WHERE pe_dll=0 AND
    data.".$type."= '".$name."' AND
    rawData.file ='PE32 executable (GUI) Intel 80386, for MS Windows\n'
    AND rawData.peframe LIKE '%\"Anti Debug\": []%'
    AND rawData.peframe LIKE '%\"Anti VM\": []%'
    ORDER BY rawData.size_of_file ASC LIMIT 0,2000;";

    if (($res = mysql_query($query)) === FALSE)
        echo "\n Impossible to execute SELECT query! ";
    
    while ($row = mysql_fetch_array($res)) {
        //name of the file (md5 sum)
		$md5=$row[0];
        shell_exec("cp -f ".$dir."/".bin2hex($md5)." ./".$name."/".bin2hex($md5));
		$i++;
    }
    echo $i."\n";
}

?>
